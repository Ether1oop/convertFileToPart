@@ -13,8 +13,6 @@ import {AddressArrayUtils} from "./library/AddressArrayUtils.sol";
 
 import {ILimaSwap} from "./interfaces/ILimaSwap.sol";
 import {ILimaTokenHelper} from "./interfaces/ILimaTokenHelper.sol";
-import {ILimaOracleReceiver} from "./interfaces/ILimaOracleReceiver.sol";
-import {ILimaOracle} from "./interfaces/ILimaOracle.sol";
 
 /**
  * @title LimaToken
@@ -29,12 +27,11 @@ contract LimaToken is ERC20PausableUpgradeSafe {
 
     event Create(address _from, uint256 _amount);
     event Redeem(address _from, uint256 _amount);
-    event RebalanceInit(address _sender);
     event RebalanceExecute(address _oldToken, address _newToken);
-    event ReadyForRebalance();
 
     // address public owner;
     ILimaTokenHelper public limaTokenHelper; //limaTokenStorage
+    mapping(address => uint256) internal userLastDeposit;
 
     /**
      * @dev Initializes contract
@@ -53,11 +50,11 @@ contract LimaToken is ERC20PausableUpgradeSafe {
 
         if (_underlyingAmount > 0 && _limaAmount > 0) {
             IERC20(limaTokenHelper.currentUnderlyingToken()).safeTransferFrom(
-                msg.sender,
+                _msgSender(),
                 address(this),
                 _underlyingAmount
             );
-            _mint(msg.sender, _limaAmount);
+            _mint(_msgSender(), _limaAmount);
         }
     }
 
@@ -114,7 +111,7 @@ contract LimaToken is ERC20PausableUpgradeSafe {
     function _isOnlyAmunUser() internal view {
         if (limaTokenHelper.isOnlyAmunUserActive()) {
             require(
-                limaTokenHelper.isAmunUser(msg.sender),
+                limaTokenHelper.isAmunUser(_msgSender()),
                 "LM3" //"AmunUsers: msg sender must be part of amunUsers."
             );
         }
@@ -315,10 +312,15 @@ contract LimaToken is ERC20PausableUpgradeSafe {
         onlyAmunUsers
         returns (bool)
     {
+        require(
+            block.number + 2 > userLastDeposit[_msgSender()],
+            "cannot withdraw within the same block"
+        );
+        userLastDeposit[_msgSender()] = block.number;
         uint256 balance = getUnderlyingTokenBalance();
 
         IERC20(_investmentToken).safeTransferFrom(
-            msg.sender,
+            _msgSender(),
             address(this),
             _amount
         );
@@ -345,7 +347,7 @@ contract LimaToken is ERC20PausableUpgradeSafe {
 
         _mint(_recipient, _amount);
 
-        emit Create(msg.sender, _amount);
+        emit Create(_msgSender(), _amount);
         return true;
     }
 
@@ -356,6 +358,11 @@ contract LimaToken is ERC20PausableUpgradeSafe {
         address _recipient,
         uint256 _minimumReturn
     ) internal onlyInvestmentToken(_payoutToken) returns (bool) {
+        require(
+            block.number + 2 > userLastDeposit[_msgSender()],
+            "cannot withdraw within the same block"
+        );
+        userLastDeposit[_msgSender()] = block.number;
         uint256 underlyingAmount = getUnderlyingTokenBalanceOf(_amount);
         _burn(_investor, _amount);
 
@@ -371,7 +378,7 @@ contract LimaToken is ERC20PausableUpgradeSafe {
             );
             underlyingAmount = underlyingAmount - fee;
         }
-        emit Redeem(msg.sender, _amount);
+        emit Redeem(_msgSender(), _amount);
 
         _amount = _swap(
             limaTokenHelper.currentUnderlyingToken(),
@@ -400,7 +407,7 @@ contract LimaToken is ERC20PausableUpgradeSafe {
     ) external returns (bool) {
         return
             _redeem(
-                msg.sender,
+                _msgSender(),
                 _payoutToken,
                 _amount,
                 _recipient,